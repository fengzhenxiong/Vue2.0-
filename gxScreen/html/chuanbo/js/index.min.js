function App(){this.$allList={dom:$("#allList"),$liMarquee:null,data:{}},this.$appList={dom:$("#appList"),$liMarquee:null,data:{}},this.$wzList={dom:$("#wzList"),$liMarquee:null,data:{}},this.$wbList={dom:$("#wbList"),$liMarquee:null,data:{}},this.$wxList={dom:$("#wxList"),$liMarquee:null,data:{}},this.liMarqueeOption={direction:"up",drag:!0,scrollamount:10},this.jqmOption={closeOnEsc:!0},this.chartOption={pie:{title:{show:!1},tooltip:{trigger:"item",formatter:"{b} : {c} ({d}%)",confine:!0},legend:{show:!1},series:[{name:"",type:"pie",radius:["20%","40%"],center:["50%","60%"],label:{normal:{formatter:function(v){var text=v.name;return text.length<3?text:text.slice(0,3)+"\n"+text.slice(3)}}},data:[]}]},colorList:["#7fc6ff","#ffa67f","#c77fff","#ffd97f","#5dd4ea","#ff827f","#c23531","#2f4554","#61a0a8","#d48265","#91c7ae","#749f83","#ca8622","#bda29a","#6e7074","#546570","#c4ccd3"],categories:[{name:"移动端",value:7},{name:"网站",value:1},{name:"微博",value:4},{name:"微信",value:8},{name:"电子报",value:5},{name:"未知",value:void 0},{name:"来源为空",value:null}]},this.charts={leftPieChart:null,rightPieChart:null,graphChart:null},this.bindJQevent(),this.render()}App.prototype.bindJQevent=function(){var self=this,echartDlgHide=function(hash){return hash.w.hide()&&hash.o&&(self.isEchartsInst("echartGraph")&&(self.charts.graphChart.dispose(),self.charts.graphChart=null),self.isEchartsInst("echartLeftPie")&&(self.charts.leftPieChart.dispose(),self.charts.leftPieChart=null),self.isEchartsInst("echartRightPie")&&(self.charts.rightPieChart.dispose(),self.charts.rightPieChart=null),hash.o.remove()),!0};$(".navList").on("click",debounce(function(){var val=$(this).data("val");$(this).addClass("check").siblings().removeClass("check"),self.getAlldocList(val)})),$(".clickMore").on("click",debounce(function(){var val=$(this).data("val"),data=[],title="",$moreDlg=$("#moreDialog"),$ul=$moreDlg.find(".dlgbody ul");switch(val){case 1:data=self.$wzList.data,title="网站";break;case 4:data=self.$wbList.data,title="微博";break;case 8:data=self.$wxList.data,title="微信";break;default:data=self.$appList.data,title="移动端"}console.log(val,"点击更多",data),console.log(self.$wxList.data,"********************"),$moreDlg.find(".dlgTitle .logo img")[0].src=self.getLogo(val),$moreDlg.find(".dlgTitle .title").text(title),$ul.html(""),self.renderMoreDlg(data).then(function(html){$ul.html(html),$moreDlg.jqm(self.jqmOption).jqmShow()})})),$(".wbOrwxList").on("click",".wbOrwxLi",debounce(function(){var $this=$(this),id=$this.data("id"),type=$this.data("clicktype");console.log(id,type);var data=self.getItem(id,type);console.log(data,"点击 微博 微信文章详情");var imgSrc="",spaninterval="",$wbOrwxDlg=$("#wbOrwxDlg"),$dlgTitle=$wbOrwxDlg.find(".dlgTitle"),$dlgbody=$wbOrwxDlg.find(".dlgbody");4===data.type?(spaninterval="转发量",imgSrc="./images/weibo.png"):(spaninterval="阅读量",imgSrc="./images/weixin.png");var title=self.htmlRestore(data.title),str='<span class="logo"><img src="'+imgSrc+'" /></span><span class="form omg">'+data.siteName+'</span><div class="info omg"><span class="type">'+spaninterval+'</span><span class="count omg">'+data.count+"</span><span>发布时间</span><span>"+data.pubTime+'</span></div><span class="jqmClose"></span><p class="ptitle omg"><a href="'+data.url+'" target="_blank">'+title+"</a></p>";$dlgTitle.html(str),$dlgbody.html(""),self.getWbOrwxContent(data.docId).then(function(_html){$dlgbody.html(_html),$wbOrwxDlg.jqm(self.jqmOption).jqmShow()})})),$(".echartList").on("click","li",debounce(function(){var $this=$(this),id=$this.data("id"),type=$this.data("clicktype"),data=self.getItem(id,type),leftPieUrl=serverDomain+"/datas/api/cas/docdetail/getMediaIndex",rightPieUrl=serverDomain+"/datas/api/cas/docdetail/getMediaReprintTypeCount";console.log(data,"总版、移动端、网站");var $echartDlg=$("#echartDlg"),$echartDlgArticle=$echartDlg.find("#echartDlgArticle");$echartDlgArticle.html(""),$echartDlg.find(".ptitle.omg").html('<a href="'+data.url+'" target="_blank">'+data.title+"</a>"),$echartDlg.jqm({closeOnEsc:!0,onHide:echartDlgHide}).jqmShow(),self.getEchartListContent(data.docId).then(function(_html){$echartDlgArticle.html(_html)}),window.setTimeout(function(){var leftPieChart=self.charts.leftPieChart=echarts.init(document.getElementById("echartLeftPie")),rightPieChart=self.charts.rightPieChart=echarts.init(document.getElementById("echartRightPie")),graphChart=self.charts.graphChart=echarts.init(document.getElementById("echartGraph"));leftPieChart.showLoading(),rightPieChart.showLoading(),graphChart.showLoading(),self.getPieData(data.docId,leftPieUrl).then(function(_data){leftPieChart.hideLoading(),self.drawPie(leftPieChart,_data)}),self.getPieData(data.docId,rightPieUrl).then(function(_data){rightPieChart.hideLoading(),self.drawPie(rightPieChart,_data)}),self.getGraphData(data.docId).then(function(_data){graphChart.hideLoading(),self.drawGraph(graphChart,_data)})},0)}))},App.prototype.render=function(){this.getAlldocList("week"),this.getAppdocList(),this.getWzdocList(),this.getWbdocList(),this.getWxdocList()},App.prototype.getAlldocList=function(dateType){var self=this,startTime="",endTime="";"week"===dateType?(startTime=this.getDate(-7),endTime=this.getDate(-1)):(startTime=this.getDate(-1),endTime=this.getDate(0)),console.log(startTime,endTime),this.loading(self.$allList.dom,!0),self.$allList.$liMarquee&&self.$allList.$liMarquee.liMarquee("destroy"),self.$allList.data={};var params={startTime:startTime,endTime:endTime,pageNum:0,pageSize:10};self.requestList1(params).done(function(res){if(""!==res.data&&self.hasKey(res.data,"content")&&res.data.content.length>0){self.loading(self.$allList.dom,!1);var content=res.data.content;console.log(content,"获取的总版数据"),self.renderAllList(content).then(function(){self.$allList.$liMarquee=self.$allList.dom.liMarquee(self.liMarqueeOption)})}else console.log("获取总版出错"),self.loading(self.$allList.dom,!1)}).fail(function(err){console.log(err,"请求出错"),self.loading(self.$allList.dom,!1)})},App.prototype.getAppdocList=function(){var self=this,startTime=this.getDate(-7),endTime=this.getDate(0);this.loading(self.$appList.dom,!0),self.$appList.$liMarquee&&self.$appList.$liMarquee.liMarquee("destroy"),self.$appList.data={};var params={startTime:startTime,endTime:endTime,pageNum:0,pageSize:10,infoType:7};self.requestList1(params).done(function(res){if(""!==res.data&&self.hasKey(res.data,"content")&&res.data.content.length>0){self.loading(self.$appList.dom,!1);var content=res.data.content;self.renderAppOrWebList(content,self.$appList).then(function(){self.$appList.$liMarquee=self.$appList.dom.liMarquee(self.liMarqueeOption)})}else self.loading(self.$appList.dom,!1)}).fail(function(err){console.log(err,"请求出错"),self.loading(self.$appList.dom,!1)})},App.prototype.getWzdocList=function(){var self=this,startTime=this.getDate(-7),endTime=this.getDate(0);this.loading(self.$wzList.dom,!0),self.$wzList.$liMarquee&&self.$wzList.$liMarquee.liMarquee("destroy"),self.$wzList.data={};var params={startTime:startTime,endTime:endTime,pageNum:0,pageSize:10,infoType:1};self.requestList1(params).done(function(res){if(""!==res.data&&self.hasKey(res.data,"content")&&res.data.content.length>0){self.loading(self.$wzList.dom,!1);var content=res.data.content;self.renderAppOrWebList(content,self.$wzList).then(function(){self.$wzList.$liMarquee=self.$wzList.dom.liMarquee(self.liMarqueeOption)})}else self.loading(self.$wzList.dom,!1)}).fail(function(err){console.log(err,"请求出错"),self.loading(self.$wzList.dom,!1)})},App.prototype.getWbdocList=function(){var self=this,startTime=this.getDate(-7),endTime=this.getDate(0);this.loading(self.$wbList.dom,!0),self.$wbList.$liMarquee&&self.$wbList.$liMarquee.liMarquee("destroy"),self.$wbList.data={};var params={startTime:startTime,endTime:endTime,pageNum:0,pageSize:10,infoType:4};self.requestList2(params).done(function(res){if(console.log(res,"获取微博数据"),""!==res.data&&self.hasKey(res.data,"content")&&res.data.content.length>0){self.loading(self.$wbList.dom,!1);var content=res.data.content;self.renderWbOrWxList(content,self.$wbList,params.infoType).then(function(){self.$wbList.$liMarquee=self.$wbList.dom.liMarquee(self.liMarqueeOption)})}else self.loading(self.$wbList.dom,!1)}).fail(function(err){console.log(err,"请求出错"),self.loading(self.$wbList.dom,!1)})},App.prototype.getWxdocList=function(){var self=this,startTime=this.getDate(-7),endTime=this.getDate(0);this.loading(self.$wxList.dom,!0),self.$wxList.$liMarquee&&self.$wxList.$liMarquee.liMarquee("destroy"),self.$wxList.data={};var params={startTime:startTime,endTime:endTime,pageNum:0,pageSize:10,infoType:8};self.requestList2(params).done(function(res){if(console.log(res,"获取微信数据"),""!==res.data&&self.hasKey(res.data,"content")&&res.data.content.length>0){self.loading(self.$wxList.dom,!1);var content=res.data.content;self.renderWbOrWxList(content,self.$wxList,params.infoType).then(function(){self.$wxList.$liMarquee=self.$wxList.dom.liMarquee(self.liMarqueeOption)})}else self.loading(self.$wxList.dom,!1)}).fail(function(err){console.log(err,"请求出错"),self.loading(self.$wxList.dom,!1)})},App.prototype.getWbOrwxContent=function(_id){var deffer=$.Deferred(),self=this,params={docId:_id,access_token:window.access_token};return $.ajax({url:serverDomain+"/datas/api/cas/commondetail/getInternetContent",contentType:"application/json;charset=UTF-8",data:params,method:"get",success:function(res){if(console.log(res,"获取微信微博详情数据"),200==res.code&&""!==res.data&&self.hasKey(res.data,"content")){var str=res.data.content;str?(str=self.htmlRestore(str),str=(str=self.htmlBR(str)).replace(/(<\/?AUDIO.*?>)|(<\/?audio.*?>)|(<\/?VIDEO.*?>)|(<\/?video.*?>)/g,""),deffer.resolve(str)):deffer.reject("")}else deffer.reject("暂无数据")},error:function(){deffer.reject("暂无数据")}}),deffer.promise()},App.prototype.getEchartListContent=function(_id){var deffer=$.Deferred(),self=this,params={docId:_id,access_token:window.access_token};return $.ajax({url:serverDomain+"/datas/api/cas/commondetail/getOriginalContent",contentType:"application/json;charset=UTF-8",data:params,method:"get",success:function(res){if(200==res.code&&""!==res.data&&self.hasKey(res.data,"content")){var str=res.data.content;str?(str=self.htmlRestore(str),str=(str=self.htmlBR(str)).replace(/(<\/?AUDIO.*?>)|(<\/?audio.*?>)|(<\/?VIDEO.*?>)|(<\/?video.*?>)/g,""),deffer.resolve(str)):deffer.reject("")}else deffer.reject("暂无数据")},error:function(){deffer.reject("暂无数据")}}),deffer.promise()},App.prototype.getPieData=function(_id,url){var deffer=$.Deferred(),params={docId:_id,access_token:window.access_token};return $.ajax({url:url,contentType:"application/json;charset=UTF-8",data:params,method:"get",success:function(res){200==res.code&&$.isArray(res.data)?deffer.resolve(res.data):deffer.reject([])},error:function(){deffer.reject([])}}),deffer.promise()},App.prototype.getGraphData=function(_id){var deffer=$.Deferred(),errorObj={nodes:[],links:[]},params={docId:_id,mediaUnitName:"广西日报传媒集团",access_token:window.access_token};return $.ajax({url:serverDomain+"/datas/api/cas/docdetail/getPropagationPath",contentType:"application/json;charset=UTF-8",data:params,method:"get",success:function(res){console.log(res,"获取关系图数据"),200==res.code&&!$.isEmptyObject(res.data)&&$.isArray(res.data.nodes)&&$.isArray(res.data.links)?deffer.resolve(res.data):deffer.reject(errorObj)},error:function(){deffer.reject(errorObj)}}),deffer.promise()},App.prototype.requestList1=function(params){var deffer=$.Deferred(),para={mediaUnitName:"广西日报传媒集团",sortOrder:"DESC",sortField:"ceiIndex",access_token:window.access_token};return para=$.extend(!1,para,params),$.ajax({url:serverDomain+"/datas/api/cas/transmission/searchList",contentType:"application/json;charset=UTF-8",data:para,method:"get",success:function(res){200==res.code?deffer.resolve(res):deffer.reject()},error:function(err){deffer.reject(err)}}),deffer.promise()},App.prototype.requestList2=function(params){var deffer=$.Deferred(),para={mediaUnitName:"广西日报传媒集团",sortOrder:"true",sortField:"IR_COUNT1",access_token:window.access_token};return para=$.extend(!1,para,params),$.ajax({url:serverDomain+"/datas/api/cas/groupdoc/searchList",contentType:"application/json;charset=UTF-8",data:para,method:"get",success:function(res){200==res.code?deffer.resolve(res):deffer.reject()},error:function(err){deffer.reject(err)}}),deffer.promise()},App.prototype.renderAllList=function(data){var deffer=$.Deferred(),self=this,_html="";return self.$allList.dom.html(""),$.each(data,function(index,item){var id=item.sid;if(id){var arr=self.getAllListHtml(item,index);self.$allList.data[id]=arr[0],_html+=arr[1]}}),self.$allList.dom.html(_html),deffer.resolve(),deffer.promise()},App.prototype.renderAppOrWebList=function(data,obj){var deffer=$.Deferred(),self=this,_html="";return obj.dom.html(""),$.each(data,function(index,item){var id=item.sid;if(id){var arr=self.getAppOrWebListHtml(item,index);obj.data[id]=arr[0],_html+=arr[1]}}),obj.dom.html(_html),_html=null,deffer.resolve(),deffer.promise()},App.prototype.renderWbOrWxList=function(data,obj,type){var deffer=$.Deferred(),self=this,_html="";return obj.dom.html(""),$.each(data,function(index,item){var id=item.docId;if(id){var arr=self.getWbOrWxListHtml(item,index,type);obj.data[id]=arr[0],_html+=arr[1]}}),obj.dom.html(_html),_html=null,deffer.resolve(),deffer.promise()},App.prototype.renderMoreDlg=function(obj){var deffer=$.Deferred(),self=this,_html="",index=0;return $.isEmptyObject(obj)?(_html="<li><span>暂无数据</span></li>>",deffer.resolve(_html),deffer.promise()):($.each(obj,function(key,item){_html+=self.getMoreDlgHtml(item,index),index++}),deffer.resolve(_html),deffer.promise())},App.prototype.getAllListHtml=function(item,index){var info=item.siteName+"-"+item.channel,_data={title:item.title,count:Math.floor(item.ceiIndex),siteName:item.siteName,channel:item.channel,time:this.handleTime(item.pubTime),logo:this.getLogo(item.infoType),url:this.handleUrl(item.urlName),docId:item.sid,picture:null};return[_data,'<li data-id="'+_data.docId+'" data-id="'+_data.docId+'" data-clicktype="allList"><div class="wDiv"><span class="theImg"><storng>'+(index+1)+'</storng></span><span class="word"><a>'+_data.title+'</a></span><span class="count">'+_data.count+'</span></div><div class="aDiv2"><span class="logo"><img src="'+_data.logo+'" /></span><span class="form">'+info+'</span><span class="pubTime">'+_data.time+"</span></div></li>"]},App.prototype.getAppOrWebListHtml=function(item,index){var info=item.siteName+"-"+item.channel,_data={title:item.title,count:Math.floor(item.ceiIndex),siteName:item.siteName,channel:item.channel,time:this.handleTime(item.pubTime),logo:this.getLogo(item.infoType),url:this.handleUrl(item.urlName),docId:item.sid,picture:this.getPicture(item.pictures),type:item.infoType},clicktype=7==item.infoType?"appList":"wzList";return[_data,'<li data-id="'+_data.docId+'" data-id="'+_data.docId+'" data-clicktype="'+clicktype+'"><div class="imgcon"><img src="'+_data.picture+'" /><span class="theImg"><storng>'+(index+1)+'</storng></span></div><div class="contentbox"><div class="nav1"><span class="listspan2">'+_data.title+'</span><span class="listspan3">'+_data.count+'</span></div><div class="nav2"><span class="logo"><img src="'+_data.logo+'" /></span><span class="listspan5">'+info+'</span><span class="listspan6">'+_data.time+"</span></div></div></li>"]},App.prototype.getWbOrWxListHtml=function(item,index,type){var spaninterval="",clicktype="";4===type?(spaninterval="转发",clicktype="wbList"):(spaninterval="阅读",clicktype="wxList"),spaninterval=spaninterval+" "+Math.floor(item.readcount);var _data={title:item.title?item.title.replace(/&nbsp;/gi,""):"",count:Math.floor(item.readcount),siteName:item.siteName,channel:item.channel,time:this.handleTime2(item.loadTime),logo:this.getLogo(type),url:this.handleUrl(item.urlName),docId:item.docId,picture:this.getPicture(item.pictures),type:type,pubTime:item.pubTime};return[_data,'<li class="wbOrwxLi" data-id="'+_data.docId+'" data-clicktype="'+clicktype+'"> <div class="imgcon"><img src="'+_data.picture+'" /><span class="theImg"><storng>'+(index+1)+'</storng></span></div><div class="contentbox"><div class="nav1"><span class="listsp2">'+_data.title+'</span></div><div class="nav2"><span class="logo"><img src="'+_data.logo+'" /></span><span class="listsp5">'+_data.siteName+'</span><span class="spaninterval">'+spaninterval+'</span><span class="listspan6">'+_data.time+"</span></div></div></li>"]},App.prototype.getMoreDlgHtml=function(item,index){return'<li><div class="row"><span class="theImg"><storng>'+(index+1)+'</storng></span><span class="word omg"><a href="'+item.url+'" target="_blank">'+item.title+"</a></span></div></li>"},App.prototype.getUrlParams=function(params){var reg=new RegExp("(^|&)"+params+"=([^&]*)(&|$)"),paramsData=window.location.search.substr(1).match(reg);return paramsData?paramsData[2]:"0"},App.prototype.getDate=function(day){function doHandleMonth(month){var m=month;return 1==month.toString().length&&(m="0"+month),m}var today=new Date,targetday_milliseconds=today.getTime()+864e5*day;today.setTime(targetday_milliseconds);var tYear=today.getFullYear(),tMonth=today.getMonth(),tDate=today.getDate()+"";return tYear+(tMonth=doHandleMonth(tMonth+1)+"")+(tDate=doHandleMonth(tDate)+"")},App.prototype.hasKey=function(parent,key){return Object.prototype.hasOwnProperty.call(parent,key)},App.prototype.handleTime=function(t){var time="";if(!t&&14!==t.length)return console.warn("时间格式传入出错"),time;var str=t.substring(0,4)+"-"+t.substring(4,6)+"-"+t.substring(6,8)+" "+t.substring(8,10)+":"+t.substring(10,12)+":"+t.substring(12,14)+":000",_t=new Date(str).getTime();return time=(time=this.getDateDiff(_t))||""},App.prototype.handleTime2=function(t){var time="";if(!t&&19!==t.length)return console.warn("时间格式传入出错"),time;var _t=Date.parse(t.replace(/-/gi,"/"));return time=(time=this.getDateDiff(_t))||""},App.prototype.getDateDiff=function(dateTimeStamp){var diffValue=(new Date).getTime()-dateTimeStamp;if(!(diffValue<0)){var monthC=diffValue/2592e6,weekC=diffValue/6048e5,dayC=diffValue/864e5,hourC=diffValue/36e5,minC=diffValue/6e4;return monthC>=1?parseInt(monthC)+"月前":weekC>=1?parseInt(weekC)+"周前":dayC>=1?parseInt(dayC)+"天前":hourC>=1?parseInt(hourC)+"小时前":minC>=1?parseInt(minC)+"分钟前":"刚刚"}},App.prototype.loading=function($dom,flag){flag?$dom.hide().siblings(".fn-s-load").show():$dom.show().siblings(".fn-s-load").hide()},App.prototype.getLogo=function(infoType){var imgSrc="";switch(infoType){case 1:imgSrc="./images/wzbig.png";break;case 4:imgSrc="./images/wbbig.png";break;case 5:case 7:imgSrc="./images/appbig.png";break;case 8:imgSrc="./images/wxbig.png";break;default:imgSrc="./images/rank.png"}return imgSrc},App.prototype.getPicture=function(picList){var picture="./images/default.png";picList&&(picture=picList.indexOf(";")>-1?picList.substring(0,picList.indexOf(";")):picList);return picture},App.prototype.drawPie=function(chart,data){for(var arr=[],option=$.extend(!1,this.chartOption.pie),i=0,l=data.length;i<l;i++){var item=data[i],color=this.chartOption.colorList[i%this.chartOption.colorList.length];item.itemStyle={normal:{color:color}},arr[i]=item}option.series[0].data=arr,chart.setOption(option)},App.prototype.drawGraph=function(chart,_data){var self=this,categories=this.chartOption.categories,categoryMap={};categories.map(function(item,i){item.itemStyle={color:self.chartOption.colorList[i%self.chartOption.colorList.length]},categoryMap[item.value]=i}),console.log(categoryMap,"categoryMap");var nodes=_data.nodes,links=_data.links;nodes.map(function(node){node.symbolSize=30,node.x=node.y=null,node.draggable=!0;var _category=categoryMap[node.group];node.category=_category||0==_category?_category:categoryMap.null});var option={title:{show:!1},type:"graph",tooltip:{trigger:"item",formatter:"{b}",confine:!0},legend:[{data:categories.map(function(a){return a.name}),textStyle:{color:"#fff"},orient:"vertical",left:0,bottom:10,icon:"circle"}],animation:!1,series:[{name:"",type:"graph",layout:"force",data:nodes,links:links,categories:categories,roam:!0,label:{normal:{position:"right",show:!0,color:"#fff"}},force:{repulsion:400}}]};chart.setOption(option),chart.on("click",function(item){if("node"===item.dataType){var url=self.handleUrl(item.data.url);window.open(url,"_blank")}})},App.prototype.htmlRestore=function(str){var s="";return 0===str.length?s:s=(s=(s=(s=(s=(s=str.replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&nbsp;/g," ")).replace(/&#39;/g,"'")).replace(/&quot;/g,'"')},App.prototype.htmlBR=function(str){var s="";return str?s=(s=str.replace(/\r\n/g,"<br />")).replace(/\n/g,"<br />"):s},App.prototype.handleUrl=function(url){return url?0!=url.indexOf("http")&&0!=url.indexOf("https")?"http://"+url:url:""},App.prototype.getItem=function(id,clicktype){var obj=[];switch(clicktype){case"wzList":obj=this.$wzList.data;break;case"wbList":obj=this.$wbList.data;break;case"wxList":obj=this.$wxList.data;break;case"appList":obj=this.$appList.data;break;default:obj=this.$allList.data}return obj[id]?obj[id]:null},App.prototype.isEchartsInst=function(_id){var flag=!1;return echarts.getInstanceByDom(document.getElementById(_id))&&(flag=!0),flag};